{"ast":null,"code":"import Stripe from 'stripe';\nimport { v4 as uuidv4 } from 'uuid';\nimport Cart from '../../models/Cart';\nimport jwt from 'jsonwebtoken';\nimport initDb from '../../helper/initDb';\nimport Order from '../../models/Order';\ninitDb();\nconst stripe = Stripe(process.env.STRIPE_SECRET);\nexport default (async (req, res) => {\n  const {\n    paymentInfo\n  } = req.body;\n  const {\n    authorization\n  } = req.headers;\n\n  if (!authorization) {\n    return res.status(401).json({\n      error: \"you must logged in\"\n    });\n  }\n\n  try {\n    const {\n      userid\n    } = jwt.verify(authorization, process.env.JWT_SECRET);\n    const cart = await Cart.findOne({\n      user: userid\n    }).populate(\"products.product\");\n    let price = 0;\n    cart.products.forEach(items => {\n      price = price + items.quantity * items.product.price;\n    }); //check kki customer pehle payment kar chuka ki a ni\n\n    let newCustomer;\n    const prevCustomer = await stripe.customers.list({\n      email: paymentInfo.email\n    });\n    const ExistingCustomer = prevCustomer.data.length > 0;\n\n    if (!ExistingCustomer) {\n      newCustomer = await stripe.customers.create({\n        email: paymentInfo.email,\n        source: paymentInfo.id\n      });\n    }\n\n    await stripe.charges.create({\n      currency: \"INR\",\n      amount: price * 100,\n      receipt_email: paymentInfo.email,\n      customer: ExistingCustomer ? prevCustomer.data[0].id : newCustomer.id,\n      description: `Your payment succesfull |${paymentInfo.email}`\n    }, {\n      idempotencyKey: uuidv4()\n    });\n    await new Order({\n      user: userid,\n      email: paymentInfo.email,\n      total: price * 100,\n      products: cart.products\n    }).save();\n    await Cart.findOneAndUpdate({\n      _id: cart._id\n    }, {\n      $set: {\n        products: []\n      }\n    });\n    res.status(200).json({\n      message: \"payment was successful\"\n    });\n  } catch (error) {\n    console.log(error);\n    return res.status(401).json({\n      error: \"login please\"\n    });\n  }\n});","map":null,"metadata":{},"sourceType":"module"}